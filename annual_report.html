<!DOCTYPE html>
<html lang="ku" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASOBRICK - Annual Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+Arabic:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="annual_report.css?v=2">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header-bar">
            <div class="header-title">
                <h1><i class="bi bi-calendar3-range me-2"></i>Annual Report</h1>
                <small style="opacity: 0.9; font-weight: 600;">ڕاپۆڕتی ساڵانە</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn-back" onclick="openAnalysisModal()"><i class="bi bi-graph-up-arrow"></i>
                    شیکاری</button>
                <button class="btn-back" onclick="openHistoryModal()"><i class="bi bi-clock-history"></i>
                    مێژوو</button>
                <a href="dashboard.html" class="btn-back"><i class="bi bi-arrow-right-circle-fill"></i> گەڕانەوە</a>
            </div>
        </div>

        <!-- Controls -->
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="reportDate" class="form-label fw-bold text-muted">بەروار هەڵبژێرە</label>
                <div class="input-group search-box">
                    <span class="input-group-text bg-white border-0"><i
                            class="bi bi-calendar-date text-primary"></i></span>
                    <input type="date" id="reportDate" class="form-control border-0 shadow-none"
                        onchange="loadDailyData()">
                </div>
            </div>
            <div class="col-md-8 text-end d-flex align-items-end justify-content-end">
                <button onclick="saveDailyData()" class="btn btn-primary btn-save px-5">
                    <span id="saveBtnText">پاشەکەوت کردن / Save</span>
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs nav-pills mb-4" id="deptTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="cutting-tab" data-bs-toggle="tab" data-bs-target="#cutting"
                    type="button" role="tab">
                    <i class="bi bi-scissors me-2"></i>بڕین و بارکردن
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="crushing-tab" data-bs-toggle="tab" data-bs-target="#crushing" type="button"
                    role="tab">
                    <i class="bi bi-gear-wide-connected me-2"></i>هاڕین و ئامادەکردن
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="unsetting-tab" data-bs-toggle="tab" data-bs-target="#unsetting"
                    type="button" role="tab">
                    <i class="bi bi-box-arrow-down me-2"></i>داگرتن
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="kiln-tab" data-bs-toggle="tab" data-bs-target="#kiln" type="button"
                    role="tab">
                    <i class="bi bi-fire me-2"></i>فڕن
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">

            <!-- Cut & Load Tab -->
            <div class="tab-pane fade show active" id="cutting" role="tabpanel">
                <div class="content-card text-start d-block">
                    <h2 class="dept-title">زانیاریەکانی بەشی بڕین و بارکردن</h2>

                    <form id="cuttingForm">
                        <!-- Group 1: Cutting Carts -->
                        <div class="section-header">
                            (ژمارەی عەرەبانەکان) <i class="bi bi-cart3"></i>
                        </div>
                        <div class="premium-row">
                            <div>
                                <label class="form-label">(کۆی گشتی)</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal total-value" id="cut_total"
                                        placeholder="0" readonly>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">(شیفتی ١)</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="cut_s1" placeholder="0"
                                        oninput="calcCuttingTotal()">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">(شیفتی ٢)</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="cut_s2" placeholder="0"
                                        oninput="calcCuttingTotal()">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">(شیفتی ٣)</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="cut_s3" placeholder="0"
                                        oninput="calcCuttingTotal()">
                                </div>
                            </div>
                        </div>

                        <div class="premium-row">
                            <div>
                                <label class="form-label d-flex justify-content-between align-items-center">
                                    جۆری بەرهەم
                                    <div class="d-flex align-items-center gap-2">
                                        <span id="prod_type_count_badge" class="badge rounded-pill bg-primary"
                                            style="font-size: 0.65rem; display:none;">Count: 0</span>
                                        <button type="button" id="btn_reset_counter"
                                            class="btn btn-ghost p-0 text-danger" style="display:none; font-size: 1rem;"
                                            title="Reset Counter" onclick="resetProductCounter()">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </label>
                                <div class="input-wrapper">
                                    <select class="form-control-minimal" id="ki_prod_type"
                                        onchange="updateProductTypeCounter()">
                                        <option value="">هەڵبژێرە...</option>
                                        <option value="بلۆکی 10">بلۆکی 10</option>
                                        <option value="بلۆکی 15">بلۆکی 15</option>
                                        <option value="بلۆکی 20">بلۆکی 20</option>
                                        <option value="بلۆکی 24">بلۆکی 24</option>
                                        <option value="10 قواطع">10 قواطع</option>
                                        <option value="15 قواطع">15 قواطع</option>
                                        <option value="20 قواطع">15 قواطع</option>
                                        <option value="24 قواطع">24 قواطع</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Group 2: Specs -->
                        <div class="section-header">
                            (پێوەرەکان) <i class="bi bi-speedometer2"></i>
                        </div>
                        <div class="premium-row">
                            <div>
                                <label class="form-label">خێرایی بۆکس فیدەر</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="boxfeeder_speed"
                                        placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">کێشی خشت</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Kg</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="brick_weight_day"
                                        placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Group 3: Loading -->
                        <div class="section-header">
                            (بارکردن) <i class="bi bi-send"></i>
                        </div>
                        <div class="premium-row">
                            <div>
                                <label class="form-label">کێشی خشت (بارکردن)</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Kg</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="brick_weight_load"
                                        placeholder="0.00">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">ژمارەی عەرەبانە لە گەراج</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="garage_carts" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">کۆی عەرەبانەی بارکردن</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="load_total_carts"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Other Tabs -->
            <div class="tab-pane fade" id="crushing" role="tabpanel">
                <div class="content-card text-start d-block">
                    <h2 class="dept-title">زانیاریەکانی بەشی هاڕین و ئامادەکردن</h2>
                    <form id="crushingForm">
                        <div class="section-header">
                            کۆیی گشتی طەن <i class="bi bi-gear-wide-connected"></i>
                        </div>
                        <div class="premium-row">
                            <div>
                                <label class="form-label">کۆی طەنی ئامادەکردن</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Ton</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="cr_prep_tones"
                                        placeholder="0.00">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">کۆی طەنی هاڕین</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Ton</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="cr_crush_tones"
                                        placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-pane fade" id="unsetting" role="tabpanel">
                <div class="content-card text-start d-block">
                    <h2 class="dept-title">زانیاریەکانی بەشی داگرتن</h2>
                    <form id="unsettingForm">
                        <div class="section-header">
                            کێشی خشتەکان <i class="bi bi-box-arrow-down"></i>
                        </div>
                        <div class="premium-row">
                            <div>
                                <label class="form-label">کێشی سەرەوە</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Kg</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="un_top_weight"
                                        placeholder="0.00">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">کێشی ناوەڕاست</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Kg</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="un_mid_weight"
                                        placeholder="0.00">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">کێشی خشتەکان خوارەوە</label>
                                <div class="input-wrapper">
                                    <span class="input-unit">Kg</span>
                                    <input type="number" step="0.01" class="form-control-minimal" id="un_bot_weight"
                                        placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-pane fade" id="kiln" role="tabpanel">
                <div class="content-card text-start d-block">
                    <h2 class="dept-title">زانیاریەکانی بەشی فڕن</h2>
                    <form id="kilnForm">
                        <div class="section-header">
                            زانیاری بەرهەم <i class="bi bi-fire"></i>
                        </div>
                        <div class="premium-row">
                            <div>
                                <label class="form-label">ژمارەی بەرهەم</label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control-minimal" id="ki_prod_count"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="global-footer">
            <img src="teg_logo.png" alt="TEG Logo" class="teg-logo-footer">
            <div class="copyright-text">&copy; 2026 Asobrick Factory System</div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg position-relative"
                style="border-radius: 20px; overflow: hidden;">
                <div
                    style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); position: absolute; top:0; left:0; width: 100%; height: 8px;">
                </div>
                <div class="modal-header border-0 bg-white p-4 mt-2">
                    <h5 class="modal-title fw-bold text-dark"><i
                            class="bi bi-graph-up-arrow me-2 text-primary"></i>ماوەی شیکاری</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <!-- Controls -->
                    <div class="glass-card mb-4" style="border-radius: 16px; padding: 20px;">
                        <div class="d-flex flex-wrap gap-2 mb-3 justify-content-center">
                            <button class="btn btn-sm btn-outline-secondary px-3 rounded-pill fw-bold"
                                onclick="setAnalysisPeriod('this_year')">ئەمساڵ</button>
                            <button class="btn btn-sm btn-outline-secondary px-3 rounded-pill fw-bold"
                                onclick="setAnalysisPeriod('this_month')">ئەم مانگە</button>
                            <button class="btn btn-sm btn-outline-secondary px-3 rounded-pill fw-bold"
                                onclick="setAnalysisPeriod('last_3_months')">٣ مانگی ڕابردوو</button>
                            <button class="btn btn-sm btn-outline-secondary px-3 rounded-pill fw-bold"
                                onclick="setAnalysisPeriod('last_12_months')">١٢ مانگی ڕابردوو</button>
                        </div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">کاتی دەستپێک</label>
                                <input type="date" id="an_startDate" class="form-control border-0 shadow-sm">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">کاتی کۆتایی</label>
                                <input type="date" id="an_endDate" class="form-control border-0 shadow-sm">
                            </div>
                            <div class="col-md-4">
                                <button onclick="calculateAnalysis()" class="btn btn-primary w-100 fw-bold shadow-sm"
                                    style="border-radius: 10px;"><i
                                        class="bi bi-calculator me-2"></i>هەژماردکردن</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="analysisResults" class="d-none">
                        <div class="row g-3 mb-4">
                            <!-- Cutting Card -->
                            <div class="col">
                                <div
                                    class="p-3 bg-white rounded-4 shadow-sm border-start border-4 border-primary h-100">
                                    <small class="text-muted fw-bold d-block mb-1">عەرەبانەکانی بڕین</small>
                                    <h4 class="fw-bold m-0 text-primary" id="res_cut_carts">0</h4>
                                </div>
                            </div>
                            <!-- Setting Card -->
                            <div class="col">
                                <div class="p-3 bg-white rounded-4 shadow-sm border-start border-4 border-info h-100">
                                    <small class="text-muted fw-bold d-block mb-1">عەرەبانەکانی بارکردن</small>
                                    <h4 class="fw-bold m-0 text-info" id="res_set_carts">0</h4>
                                </div>
                            </div>
                            <!-- Crushing Card -->
                            <div class="col">
                                <div
                                    class="p-3 bg-white rounded-4 shadow-sm border-start border-4 border-success h-100">
                                    <small class="text-muted fw-bold d-block mb-1">خۆڵی هاڕین (طەن)</small>
                                    <h4 class="fw-bold m-0 text-success" id="res_cr_tons">0</h4>
                                </div>
                            </div>
                            <!-- Prep Card -->
                            <div class="col">
                                <div
                                    class="p-3 bg-white rounded-4 shadow-sm border-start border-4 border-secondary h-100">
                                    <small class="text-muted fw-bold d-block mb-1">خۆڵی ئامادەکردن (طەن)</small>
                                    <h4 class="fw-bold m-0 text-secondary" id="res_prep_tons">0</h4>
                                </div>
                            </div>
                            <!-- Kiln Card -->
                            <div class="col">
                                <div
                                    class="p-3 bg-white rounded-4 shadow-sm border-start border-4 border-warning h-100">
                                    <small class="text-muted fw-bold d-block mb-1">بەرهەم (بە گشتی)</small>
                                    <h4 class="fw-bold m-0 text-warning" id="res_ki_carts">0</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Product Type Breakdown -->
                        <div id="productTypeBreakdown" class="mb-4">
                            <!-- Populated via JS -->
                        </div>

                        <!-- Chart Section (Individual Department Charts) -->
                        <!-- Chart Section (5 Individual Charts) -->
                        <div class="row g-3 mt-2">
                            <div class="col-md-6 col-lg-4">
                                <div class="bg-white p-3 rounded-4 shadow-sm h-100">
                                    <h6 class="fw-bold mb-2 text-muted small">عەرەبانەکانی بڕین</h6>
                                    <canvas id="chart_cut" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="bg-white p-3 rounded-4 shadow-sm h-100">
                                    <h6 class="fw-bold mb-2 text-muted small">عەرەبانەکانی بارکردن</h6>
                                    <canvas id="chart_set" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="bg-white p-3 rounded-4 shadow-sm h-100">
                                    <h6 class="fw-bold mb-2 text-muted small">خۆڵی هاڕین (طەن)</h6>
                                    <canvas id="chart_cr" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-6">
                                <div class="bg-white p-3 rounded-4 shadow-sm h-100">
                                    <h6 class="fw-bold mb-2 text-muted small">خۆڵی ئامادەکردن (طەن)</h6>
                                    <canvas id="chart_prep" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-md-12 col-lg-6">
                                <div class="bg-white p-3 rounded-4 shadow-sm h-100">
                                    <h6 class="fw-bold mb-2 text-muted small">عەرەبانەکانی فڕن</h6>
                                    <canvas id="chart_ki_final" height="150"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Zoom Modal -->
    <div class="modal fade" id="chartZoomModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header border-0 bg-white p-4">
                    <h5 class="modal-title fw-bold text-dark" id="zoomModalTitle">گەورەکردن</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div class="bg-white p-3 rounded-4 shadow-sm">
                        <canvas id="zoomedChartCanvas" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; background: #f8fafc;">
                <div class="modal-header border-0 bg-white p-4" style="border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title fw-bold text-primary"><i class="bi bi-archive me-2"></i>مێژووی تۆمارەکان</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb history-breadcrumb" id="historyBreadcrumb">
                            <li class="breadcrumb-item active" aria-current="page">مانگەکان</li>
                        </ol>
                    </nav>
                    <!-- View Container -->
                    <div id="historyContent">
                        <!-- Folders or Table will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script> // --- Configuration ---

        const firebaseConfig = {
            apiKey: "AIzaSyDNodAq9MikVHaQRr4EZVfsbXp4SOfxDKQ",
            authDomain: "abf6-96dcf.firebaseapp.com",
            projectId: "abf6-96dcf",
            storageBucket: "abf6-96dcf.firebasestorage.app",
            messagingSenderId: "405357996484",
            appId: "1:405357996484:web:b335cdf768ba415f3e9c91"
        }

            ;
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Init ---
        // --- Init ---
        let currentUser = null;
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('currentUser');
            if (!userStr) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            if (currentUser.username === 'unemp' || currentUser.role === 'employee' || currentUser.role === 'hr') {
                alert('You do not have permission to access this page.');
                window.location.href = 'dashboard.html';
                return;
            }
            // Show reset button if admin or himat
            if (currentUser.username === 'admin' || currentUser.username === 'himat') {
                document.getElementById('btn_reset_counter').style.display = 'inline-block';
            }
        });

        // --- Logic ---
        function calcCuttingTotal() {
            const s1 = parseFloat(document.getElementById('cut_s1').value) || 0;
            const s2 = parseFloat(document.getElementById('cut_s2').value) || 0;
            const s3 = parseFloat(document.getElementById('cut_s3').value) || 0;
            const total = s1 + s2 + s3;
            document.getElementById('cut_total').value = total;
        }

        async function updateProductTypeCounter() {
            const type = document.getElementById('ki_prod_type').value;
            const badge = document.getElementById('prod_type_count_badge');
            const date = document.getElementById('reportDate').value;

            if (!type || !date) {
                badge.style.display = 'none';
                return;
            }

            try {
                // Fetch latest reset for this type (specific or global 'ALL')
                const resetSnap = await db.collection('annual_report_config').doc('resets').get();
                let lastResetDate = '0000-00-00';
                if (resetSnap.exists) {
                    const resets = resetSnap.data().resets || [];
                    const applicableResets = resets.filter(r => (r.type === type || r.type === 'ALL') && r.date <= date).map(r => r.date);
                    if (applicableResets.length > 0) {
                        lastResetDate = applicableResets.sort().reverse()[0];
                    }
                }

                // Count documents since last reset
                const snapshot = await db.collection('annual_daily_records')
                    .where('kiln.prod_type', '==', type)
                    .where(firebase.firestore.FieldPath.documentId(), '>=', lastResetDate)
                    .where(firebase.firestore.FieldPath.documentId(), '<=', date)
                    .get();

                const count = snapshot.size;
                badge.innerText = `Count: ${count}`;
                badge.style.display = 'inline-block';
            } catch (error) {
                console.error("Error counting product types:", error);
                badge.style.display = 'none';
            }
        }

        async function resetProductCounter() {
            const date = document.getElementById('reportDate').value;
            if (!date) {
                alert("Please select a date first.");
                return;
            }

            if (!confirm(`Are you sure?`)) {
                return;
            }

            try {
                const marker = {
                    type: 'ALL',
                    date: date,
                    by: currentUser.username
                };
                await db.collection('annual_report_config').doc('resets').set({
                    resets: firebase.firestore.FieldValue.arrayUnion(marker)
                }, { merge: true });

                alert("Counter reset successfully for all types!");
                updateProductTypeCounter();
            } catch (error) {
                console.error("Reset Error:", error);
                alert("Failed to reset counter.");
            }
        }

        async function saveDailyData() {
            const date = document.getElementById('reportDate').value;

            if (!date) {
                alert("تکایە بەروارێک هەڵبژێرە");
                return;
            }

            const btn = document.querySelector('.btn-save');
            const originalText = document.getElementById('saveBtnText').innerText;
            btn.disabled = true;
            document.getElementById('saveBtnText').innerText = "Saving...";

            const data = {
                permissions: {
                    last_updated_by: getCurrentUser()
                }

                ,
                cutting_loading: {
                    shift1: Number(document.getElementById('cut_s1').value),
                    shift2: Number(document.getElementById('cut_s2').value),
                    shift3: Number(document.getElementById('cut_s3').value),
                    total: Number(document.getElementById('cut_total').value),
                    brick_weight_day: Number(document.getElementById('brick_weight_day').value),
                    boxfeeder_speed: Number(document.getElementById('boxfeeder_speed').value),
                    loading_total: Number(document.getElementById('load_total_carts').value),
                    garage_carts: Number(document.getElementById('garage_carts').value),
                    brick_weight_load: Number(document.getElementById('brick_weight_load').value)
                }

                ,
                unsetting: {
                    top_weight: Number(document.getElementById('un_top_weight').value),
                    mid_weight: Number(document.getElementById('un_mid_weight').value),
                    bot_weight: Number(document.getElementById('un_bot_weight').value)
                }

                ,
                crushing_prep: {
                    prep_tones: Number(document.getElementById('cr_prep_tones').value),
                    crush_tones: Number(document.getElementById('cr_crush_tones').value)
                }

                ,
                kiln: {
                    prod_type: document.getElementById('ki_prod_type').value,
                    prod_count: Number(document.getElementById('ki_prod_count').value)
                }
            }

                ;

            try {
                await db.collection('annual_daily_records').doc(date).set(data, {
                    merge: true
                });
                // Show success feedback (simple for now)
                btn.classList.replace('btn-primary', 'btn-success');
                document.getElementById('saveBtnText').innerText = "Saved Successfully!";

                setTimeout(() => {
                    btn.classList.replace('btn-success', 'btn-primary');
                    document.getElementById('saveBtnText').innerText = originalText;
                    btn.disabled = false;
                }

                    , 2000);
            }

            catch (error) {
                console.error("Error saving document: ", error);
                alert("Error saving data: " + error.message);
                btn.disabled = false;
                document.getElementById('saveBtnText').innerText = originalText;
            }
        }

        async function loadDailyData() {
            const date = document.getElementById('reportDate').value;
            if (!date) return;

            // Clear forms first
            document.getElementById('cuttingForm').reset();
            document.getElementById('crushingForm').reset();
            document.getElementById('unsettingForm').reset();
            document.getElementById('kilnForm').reset();

            try {
                const doc = await db.collection('annual_daily_records').doc(date).get();

                if (doc.exists) {
                    const data = doc.data();

                    // Populate Cutting & Loading
                    if (data.cutting_loading) {
                        document.getElementById('cut_s1').value = data.cutting_loading.shift1 || '';
                        document.getElementById('cut_s2').value = data.cutting_loading.shift2 || '';
                        document.getElementById('cut_s3').value = data.cutting_loading.shift3 || '';
                        document.getElementById('cut_total').value = data.cutting_loading.total || '';

                        if (document.getElementById('cut_total_display')) {
                            document.getElementById('cut_total_display').innerText = data.cutting_loading.total || '0';
                        }

                        document.getElementById('brick_weight_day').value = data.cutting_loading.brick_weight_day || '';
                        document.getElementById('boxfeeder_speed').value = data.cutting_loading.boxfeeder_speed || '';
                        document.getElementById('load_total_carts').value = data.cutting_loading.loading_total || '';
                        document.getElementById('garage_carts').value = data.cutting_loading.garage_carts || '';
                        document.getElementById('brick_weight_load').value = data.cutting_loading.brick_weight_load || '';
                    }

                    // Populate Unsetting
                    if (data.unsetting) {
                        document.getElementById('un_top_weight').value = data.unsetting.top_weight || '';
                        document.getElementById('un_mid_weight').value = data.unsetting.mid_weight || '';
                        document.getElementById('un_bot_weight').value = data.unsetting.bot_weight || '';
                    }

                    // Populate Crushing
                    if (data.crushing_prep) {
                        document.getElementById('cr_prep_tones').value = data.crushing_prep.prep_tones || '';
                        document.getElementById('cr_crush_tones').value = data.crushing_prep.crush_tones || '';
                    }

                    // Populate Kiln
                    if (data.kiln) {
                        document.getElementById('ki_prod_type').value = data.kiln.prod_type || '';
                        document.getElementById('ki_prod_count').value = data.kiln.prod_count || '';
                        updateProductTypeCounter();
                    }
                }
            }

            catch (error) {
                console.error("Error getting document: ", error);
            }
        }

        // --- History Logic ---
        let historyModal;

        function openHistoryModal() {
            if (!historyModal) {
                historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            }

            historyModal.show();
            loadMonths();
        }

        async function loadMonths() {
            const container = document.getElementById('historyContent');
            const breadcrumb = document.getElementById('historyBreadcrumb');

            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
            breadcrumb.innerHTML = '<li class="breadcrumb-item active">Months</li>';

            try {
                // Get all documents to extract unique year-months
                // Note: Efficient way would be to store a 'months' metadata collection, 
                // but for now we scan the collection as requested.
                const snapshot = await db.collection('annual_daily_records').get();
                const months = new Set();

                snapshot.forEach(doc => {
                    // ID is YYYY-MM-DD
                    const date = doc.id;

                    if (date.length === 10) {
                        const month = date.substring(0, 7); // YYYY-MM
                        months.add(month);
                    }
                });

                const sortedMonths = Array.from(months).sort().reverse();

                if (sortedMonths.length === 0) {
                    container.innerHTML = '<div class="text-center p-5 text-muted">No records found.</div>';
                    return;
                }

                let html = '<div class="folder-grid">';
                sortedMonths.forEach(month => {
                    html += `
                        <div class="folder-item" onclick="loadMonthTable('${month}')">
                            <i class="bi bi-folder-fill folder-icon"></i>
                            <div class="folder-name">${month}</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            }

            catch (error) {
                console.error("Error loading history:", error);
                container.innerHTML = '<div class="text-danger text-center p-3">Error loading history.</div>';
            }
        }

        // --- Analysis Logic ---
        let analysisModal;

        function openAnalysisModal() {
            if (!analysisModal) {
                analysisModal = new bootstrap.Modal(document.getElementById('analysisModal'));
            }

            analysisModal.show();
        }

        let charts = { cut: null, set: null, cr: null, prep: null, ki: null };
        let zoomedChart = null;

        function openZoomModal(id, label, data, color, type) {
            const modalEl = document.getElementById('chartZoomModal');
            document.getElementById('zoomModalTitle').innerText = label;
            const modal = new bootstrap.Modal(modalEl);

            modalEl.addEventListener('shown.bs.modal', function onShown() {
                modalEl.removeEventListener('shown.bs.modal', onShown);
                const ctx = document.getElementById('zoomedChartCanvas').getContext('2d');
                if (zoomedChart) zoomedChart.destroy();

                zoomedChart = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: charts[id].data.labels,
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '33',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: false }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            });

            modal.show();
        }

        function setAnalysisPeriod(type) {
            const now = new Date();
            let start = new Date();
            let end = new Date();

            if (type === 'this_year') {
                start = new Date(now.getFullYear(), 0, 1);
            } else if (type === 'this_month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (type === 'last_3_months') {
                start.setMonth(now.getMonth() - 3);
            } else if (type === 'last_12_months') {
                start.setFullYear(now.getFullYear() - 1);
            }

            // Adjust to local date string YYYY-MM-DD
            const toISO = (d) => d.toISOString().split('T')[0];
            document.getElementById('an_startDate').value = toISO(start);
            document.getElementById('an_endDate').value = toISO(end);

            calculateAnalysis();
        }

        async function calculateAnalysis() {
            const start = document.getElementById('an_startDate').value;
            const end = document.getElementById('an_endDate').value;

            if (!start || !end) {
                alert("تکایە ماوەیەک هەڵبژێرە");
                return;
            }

            const btn = document.querySelector('#analysisModal button.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Computing...';
            btn.disabled = true;

            try {
                const snapshot = await db.collection('annual_daily_records').where(firebase.firestore.FieldPath.documentId(), '>=', start).where(firebase.firestore.FieldPath.documentId(), '<=', end).get();

                if (snapshot.empty) {
                    alert("No records found in this range.");
                    return;
                }

                let stats = {
                    cut_carts: 0,
                    set_carts: 0,
                    cr_tons: 0,
                    prep_tons: 0,
                    ki_carts: 0,
                    labels: [],
                    data_cut: [],
                    data_set: [],
                    data_cr: [],
                    data_prep: [],
                    data_ki: [],
                    prod_breakdown: {}
                };

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const cut = d.cutting_loading || {};
                    const cr = d.crushing_prep || {};
                    const ki = d.kiln || {};

                    stats.cut_carts += Number(cut.total) || 0;
                    stats.set_carts += Number(cut.loading_total) || 0;
                    stats.cr_tons += Number(cr.crush_tones) || 0;
                    stats.prep_tons += Number(cr.prep_tones) || 0;
                    stats.ki_carts += Number(ki.prod_count) || 0;

                    if (ki.prod_type) {
                        stats.prod_breakdown[ki.prod_type] = (stats.prod_breakdown[ki.prod_type] || 0) + 1;
                    }

                    stats.labels.push(doc.id);
                    stats.data_cut.push(Number(cut.total) || 0);
                    stats.data_set.push(Number(cut.loading_total) || 0);
                    stats.data_cr.push(Number(cr.crush_tones) || 0);
                    stats.data_prep.push(Number(cr.prep_tones) || 0);
                    stats.data_ki.push(Number(ki.prod_count) || 0);
                });

                // Update UI Numbers
                document.getElementById('res_cut_carts').innerText = stats.cut_carts;
                document.getElementById('res_set_carts').innerText = stats.set_carts;
                document.getElementById('res_cr_tons').innerText = stats.cr_tons.toFixed(1);
                document.getElementById('res_prep_tons').innerText = stats.prep_tons.toFixed(1);
                document.getElementById('res_ki_carts').innerText = stats.ki_carts;

                // Update Breakdown UI
                const breakdownEl = document.getElementById('productTypeBreakdown');
                breakdownEl.innerHTML = '<h6 class="fw-bold mb-3 text-muted"><i class="bi bi-list-stars me-2"></i>جۆرەکانی بەرهەم</h6>';
                const grid = document.createElement('div');
                grid.className = 'row row-cols-2 row-cols-md-4 g-2';

                Object.entries(stats.prod_breakdown).forEach(([type, count]) => {
                    grid.innerHTML += `
                        <div class="col">
                            <div class="p-2 bg-white rounded-3 shadow-sm border-start border-3 border-primary d-flex justify-content-between align-items-center">
                                <small class="fw-bold text-dark">${type}</small>
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </div>
                        </div>
                    `;
                });
                breakdownEl.appendChild(grid);

                // Render Charts
                const render = (id, label, data, color, type = 'line') => {
                    if (charts[id]) charts[id].destroy();
                    const canvasId = (id === 'ki') ? 'chart_ki_final' : 'chart_' + id;
                    const el = document.getElementById(canvasId);
                    if (!el) return;
                    const ctx = el.getContext('2d');
                    el.style.cursor = 'pointer';
                    el.onclick = () => openZoomModal(id, label, data, color, type);

                    charts[id] = new Chart(ctx, {
                        type: type,
                        data: {
                            labels: stats.labels,
                            datasets: [{
                                label: label,
                                data: data,
                                borderColor: color,
                                backgroundColor: color + '1a',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                };

                render('cut', 'عەرەبانەکانی بڕین', stats.data_cut, '#3b82f6');
                render('set', 'عەرەبانەکانی بارکردن', stats.data_set, '#0ea5e9');
                render('cr', 'خۆڵی هاڕین', stats.data_cr, '#10b981');
                render('prep', 'خۆڵی ئامادەکردن', stats.data_prep, '#64748b');
                render('ki', 'بەرهەمی فڕن', stats.data_ki, '#ef4444', 'bar');


                document.getElementById('analysisResults').classList.remove('d-none');

            }

            catch (error) {
                console.error("Analysis Error:", error);
                alert("Error calculating analysis.");
            }

            finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadMonthTable(month) {
            // month = YYYY-MM
            const container = document.getElementById('historyContent');
            const breadcrumb = document.getElementById('historyBreadcrumb');

            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';

            // Update Breadcrumb
            breadcrumb.innerHTML = `<li class="breadcrumb-item"><a href="#" onclick="loadMonths(); return false;">Months</a></li><li class="breadcrumb-item active">${month}</li>`;

            try {
                // Query strings strictly: start at "2026-01-01" end at "2026-01-31" effectively
                // Using string range comparison on Document ID (Date)
                const snapshot = await db.collection('annual_daily_records').where(firebase.firestore.FieldPath.documentId(), '>=', month + '-01').where(firebase.firestore.FieldPath.documentId(), '<=', month + '-31').get();

                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center p-5 text-muted">No records found for this month.</div>';
                    return;
                }

                let records = [];

                snapshot.forEach(doc => {
                    records.push({
                        id: doc.id, ...doc.data()
                    });
                });

                // Sort by date ascending
                records.sort((a, b) => a.id.localeCompare(b.id));

                // Get all resets
                const resetSnap = await db.collection('annual_report_config').doc('resets').get();
                const allResets = resetSnap.exists ? (resetSnap.data().resets || []) : [];

                // Pre-calculate era base counts for performance
                let eraBaseCounts = {};
                const erasToFetch = [];

                records.forEach(rec => {
                    const type = rec.kiln?.prod_type;
                    if (!type) return;

                    const applicableResets = allResets.filter(r => (r.type === type || r.type === 'ALL') && r.date <= rec.id).map(r => r.date);
                    const lastResetDate = applicableResets.length > 0 ? applicableResets.sort().reverse()[0] : '0000-00-00';
                    const eraKey = `${type}_${lastResetDate}`;

                    if (!eraBaseCounts.hasOwnProperty(eraKey)) {
                        eraBaseCounts[eraKey] = 0;
                        // If reset era started before this month, we need to fetch the historical count
                        if (lastResetDate < month + '-01') {
                            erasToFetch.push({ type, lastResetDate, eraKey });
                        }
                    }
                });

                // Fetch base counts in parallel
                await Promise.all(erasToFetch.map(async era => {
                    const snap = await db.collection('annual_daily_records')
                        .where('kiln.prod_type', '==', era.type)
                        .where(firebase.firestore.FieldPath.documentId(), '>=', era.lastResetDate)
                        .where(firebase.firestore.FieldPath.documentId(), '<', month + '-01')
                        .get();
                    eraBaseCounts[era.eraKey] = snap.size;
                }));

                // Build Table
                let totals = {
                    total: 0, load: 0, garage: 0, speed: 0, bw1: 0, bw2: 0,
                    prep: 0, crush: 0, top: 0, mid: 0, bot: 0, ki_count: 0
                };

                let tableHtml = ` <div class="history-table-wrapper"><table class="history-table"><thead><tr><th rowspan="2">Date</th><th colspan="7" class="bg-primary text-white">بڕین و بارکردن</th><th colspan="2" class="bg-success text-white">هاڕین و ئامادەکردن</th><th colspan="3" class="bg-info text-dark">داگرتن</th><th colspan="1" class="bg-warning text-dark">فڕن</th><th rowspan="2">Actions</th></tr><tr><th>عەرەبانەی بڕین</th><th>عەرەبانەی بارکردن</th><th>عەرەبانەی گەڕاج</th><th>خێرایی بۆکسفیدەر</th><th>کێشی خشت</th><th>کێشی خشت (بار)</th><th>جۆری بەرهەم</th><th>ئامادەکردن طەن</th><th>هاڕین طەن</th><th>ک.سەرەوە</th><th>ک.ناوەڕاست</th><th>ک.خوارەوە</th><th>ژمارەی بەرهەم</th></tr></thead><tbody>`;

                records.forEach(rec => {
                    const cut = rec.cutting_loading || {};
                    const cr = rec.crushing_prep || {};
                    const un = rec.unsetting || {};
                    const ki = rec.kiln || {};

                    // Accumulate Totals
                    totals.total += Number(cut.total) || 0;
                    totals.load += Number(cut.loading_total) || 0;
                    totals.garage += Number(cut.garage_carts) || 0;
                    totals.speed += Number(cut.boxfeeder_speed) || 0;
                    totals.bw1 += Number(cut.brick_weight_day) || 0;
                    totals.bw2 += Number(cut.brick_weight_load) || 0;
                    totals.prep += Number(cr.prep_tones) || 0;
                    totals.crush += Number(cr.crush_tones) || 0;
                    totals.top += Number(un.top_weight) || 0;
                    totals.mid += Number(un.mid_weight) || 0;
                    totals.bot += Number(un.bot_weight) || 0;
                    totals.ki_count += Number(ki.prod_count) || 0;

                    // Product Sequence
                    let sequenceNum = '';
                    if (ki.prod_type) {
                        const applicableResets = allResets.filter(r => (r.type === ki.prod_type || r.type === 'ALL') && r.date <= rec.id).map(r => r.date);
                        const lastResetDate = applicableResets.length > 0 ? applicableResets.sort().reverse()[0] : '0000-00-00';
                        const eraKey = `${ki.prod_type}_${lastResetDate}`;

                        if (eraBaseCounts.hasOwnProperty(eraKey)) {
                            eraBaseCounts[eraKey]++;
                            sequenceNum = ` - ${eraBaseCounts[eraKey]}`;
                        }
                    }

                    tableHtml += `
                        <tr>
                            <td class="fw-bold">${rec.id}</td>
                            <td class="total-col bg-light-cut text-dept-cut fw-bold">${cut.total || 0}</td>
                            <td class="bg-light-cut text-dept-cut">${cut.loading_total || 0}</td>
                            <td class="bg-light-cut text-dept-cut">${cut.garage_carts || 0}</td>
                            <td class="bg-light-cut text-dept-cut">${cut.boxfeeder_speed || 0}</td>
                            <td class="bg-light-cut text-dept-cut">${cut.brick_weight_day || 0}</td>
                            <td class="bg-light-cut text-dept-cut">${cut.brick_weight_load || 0}</td>
                            <td class="bg-light-cut text-dept-cut fw-bold" style="font-size: 0.75rem">${ki.prod_type ? ki.prod_type + sequenceNum : '-'}</td>
                            <td class="bg-light-crush text-dept-crush">${cr.prep_tones || 0}</td>
                            <td class="bg-light-crush text-dept-crush">${cr.crush_tones || 0}</td>
                            <td class="bg-light-un text-dept-un">${un.top_weight || 0}</td>
                            <td class="bg-light-un text-dept-un">${un.mid_weight || 0}</td>
                            <td class="bg-light-un text-dept-un">${un.bot_weight || 0}</td>
                            <td class="bg-light-ki text-dept-ki">${ki.prod_count || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadHistDate('${rec.id}')">
                                    <i class="bi bi-box-arrow-in-down-right"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                // Add Totals Row
                tableHtml += `
                    </tbody>
                    <tfoot class="history-footer-row">
                        <tr>
                            <td class="fw-bold">کۆی گشتی</td>
                            <td class="bg-light-cut text-dept-cut">${totals.total}</td>
                            <td class="bg-light-cut text-dept-cut">${totals.load}</td>
                            <td class="bg-light-cut text-dept-cut">${totals.garage}</td>
                            <td class="bg-light-cut text-dept-cut">${totals.speed.toFixed(1)}</td>
                            <td class="bg-light-cut text-dept-cut">${totals.bw1.toFixed(2)}</td>
                            <td class="bg-light-cut text-dept-cut">${totals.bw2.toFixed(2)}</td>
                            <td class="bg-light-cut text-dept-cut">-</td>
                            <td class="bg-light-crush text-dept-crush">${totals.prep.toFixed(1)}</td>
                            <td class="bg-light-crush text-dept-crush">${totals.crush.toFixed(1)}</td>
                            <td class="bg-light-un text-dept-un">${totals.top.toFixed(2)}</td>
                            <td class="bg-light-un text-dept-un">${totals.mid.toFixed(2)}</td>
                            <td class="bg-light-un text-dept-un">${totals.bot.toFixed(2)}</td>
                            <td class="bg-light-ki text-dept-ki">${totals.ki_count}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table></div>`;
                container.innerHTML = tableHtml;

            }

            catch (error) {
                console.error("Error loading month table:", error);
                container.innerHTML = '<div class="text-danger text-center p-3">Error loading table.</div>';
            }
        }

        function loadHistDate(date) {
            document.getElementById('reportDate').value = date;
            loadDailyData(); // From existing logic
            historyModal.hide();
        }

        function getCurrentUser() {
            const userStr = localStorage.getItem('currentUser');
            return userStr ? JSON.parse(userStr).username : 'unknown';
        }

    </script>
    <style>
        /* Extra styles for the new UI */
        .search-box {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            color: var(--text-dark);
            font-weight: 700;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .analysis-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
    </style>
</body>

</html>


