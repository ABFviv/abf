<!DOCTYPE html>
<html lang="ku" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASOBRICK - چاکسازی قاڵب</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="maintenance.css">
    <style>
        :root {
            --bg-body: #f1f5f9;
            --text-main: #0f172a;
            --text-muted: #475569;
            --accent-primary: #5B7C99;
            --accent-secondary: #3a5061;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --card-white: #ffffff;
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.12);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', 'Noto Sans Arabic', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Universal Premium Header --- */
        .page-header {
            background: rgba(91, 124, 153, 0.6);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            padding: 24px 48px;
            border-radius: 35px;
            margin-bottom: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .header-title h1 {
            font-weight: 800;
            margin: 0;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, #000000 0%, #3a5061 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2rem;
        }

        /* --- Hero Section (Active Mold) --- */
        .hero-section {
            margin-bottom: 50px;
            perspective: 1000px;
        }

        .active-mold-card {
            background: var(--card-white);
            border-radius: 30px;
            padding: 40px;
            box-shadow: var(--shadow-soft);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.5s ease;
        }

        /* Aurora effect behind active card */
        .active-mold-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.08) 0%, transparent 70%);
            z-index: 0;
            pointer-events: none;
        }

        .hero-content {
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.8rem;
            width: fit-content;
            margin-bottom: 20px;
        }

        .status-pill i {
            font-size: 0.6rem;
            animation: pulse 2s infinite;
            color: var(--accent-primary);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .active-name {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .active-meta {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .hero-stats {
            display: flex;
            gap: 40px;
        }

        .hero-stat-item h4 {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            color: var(--text-main);
        }

        .hero-stat-item span {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Circular Progress */
        .hero-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-circle {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-primary) 0%, var(--accent-primary) 82%, #f3f4f6 82%, #f3f4f6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(91, 124, 147, 0.2);
            transition: background 1s ease;
            cursor: pointer;
        }

        .progress-circle:hover {
            transform: scale(1.02);
        }

        .progress-circle::after {
            content: '';
            position: absolute;
            width: 210px;
            height: 210px;
            border-radius: 50%;
            background: white;
        }

        .progress-text {
            position: absolute;
            z-index: 2;
            text-align: center;
        }

        .progress-days {
            font-size: 4rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            transition: font-size 0.2s;
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* --- Inventory Grid --- */
        .inventory-section h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }

        .grid-header {
            grid-column: 1 / -1;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .grid-category-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-size-title {
            display: none;
            /* Sizes will be shown in cards */
        }

        .inv-card {
            background: white;
            border-radius: 10px;
            padding: 8px 12px;
            border: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .inv-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-soft);
            border-color: #e5e7eb;
        }

        .inv-icon {
            width: 28px;
            height: 28px;
            background: #f9fafb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .inv-card:hover .inv-icon {
            background: var(--accent-primary);
            color: white;
        }

        .inv-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .inv-name-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
        }

        .inv-name {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inv-size-badge {
            font-size: 0.65rem;
            font-weight: 700;
            color: #64748b;
            background: #f1f5f9;
            padding: 1px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .inv-status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 2px;
        }

        .inv-status {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .inv-status::before {
            content: '';
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #d1d5db;
        }

        .inv-health-mini {
            font-size: 0.65rem;
            color: #9ca3af;
        }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            .active-mold-card {
                grid-template-columns: 1fr;
                padding: 30px;
            }

            .hero-visual {
                margin-top: 30px;
            }
        }

        .history-row:hover {
            background-color: rgba(91, 124, 153, 0.02) !important;
            transition: all 0.2s ease;
        }

        .history-row {
            transition: all 0.2s ease;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>

    <div class="container" style="max-width: 1200px;">
        <!-- Header -->
        <div class="page-header">
            <div class="header-title">
                <h1>Mold Maintenance</h1>
                <small style="opacity: 0.9; font-weight: 600;">چاکسازی قاڵب</small>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <div class="d-none d-md-flex align-items-center gap-2"
                    style="background: rgba(255,255,255,0.8); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--glass-border);">
                    <i class="bi bi-person-circle text-secondary"></i>
                    <span id="userInfoDisplay" class="fw-bold" style="font-size: 0.9rem;">User</span>
                </div>
                <button id="btnSync" class="btn btn-light rounded-pill px-4 fw-bold shadow-sm" onclick="syncFromCloud()"
                    style="border: 1px solid #e2e8f0; color: var(--accent-primary);">
                    <i class="bi bi-cloud-arrow-down-fill me-2"></i> Sync
                </button>
                <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="openAnalysis()"
                    style="background: var(--accent-primary); border: none; box-shadow: 0 4px 12px rgba(91, 124, 153, 0.3);">
                    <i class="bi bi-graph-up me-2"></i> شیکاری
                </button>
                <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="openHistory()"
                    style="background: var(--accent-primary); border: none; box-shadow: 0 4px 12px rgba(91, 124, 153, 0.3);">
                    <i class="bi bi-clock-history me-2"></i> مێژوو
                </button>
                <a href="dashboard.html" class="btn btn-light rounded-pill px-4 fw-bold shadow-sm"
                    style="border: 1px solid #e2e8f0;">
                    <i class="bi bi-arrow-left-circle-fill me-2"></i> گەڕانەوە
                </a>
            </div>
        </div>

        <!-- HERO: Active Mold -->
        <div class="hero-section" id="heroSection">
            <div class="active-mold-card">
                <div class="hero-content">
                    <div class="status-pill"><i class="bi bi-circle-fill"></i> قاڵبەکە چالاکە</div>
                    <div class="active-name" id="activeName">چاوەڕوان...</div>
                    <div class="active-meta">سووڕی چالاکی قاڵب</div>

                    <div class="hero-stats">
                        <div class="hero-stat-item">
                            <h4 id="activeStarted">--</h4>
                            <span>بەرواری دەستپێکردن</span>
                        </div>
                        <div class="hero-stat-item">
                            <h4 id="activeHealth">--%</h4>
                            <span>تەمەنی قاڵب</span>
                        </div>
                    </div>

                    <div class="mt-4 d-flex gap-3" id="actionButtons">
                        <!-- Buttons injected via JS -->
                    </div>
                </div>
                <div class="hero-visual">
                    <div class="progress-circle" id="progressCircle" onclick="toggleTimeFormat()"
                        title="Click to toggle details">
                        <div class="progress-text">
                            <div class="progress-days" id="daysRunning">0</div>
                            <div class="progress-label">ژمارەی ڕۆژی کارکردن</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Grid -->
        <div class="inventory-section">
            <h3>قاڵبە بەردەستەکان</h3>
            <div class="inventory-grid" id="inventoryGrid">
                <!-- Grid Items Injected via JS -->
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; border: none; overflow: hidden;">
                <div class="modal-header"
                    style="background: rgba(91, 124, 153, 0.1); border-bottom: 1px solid rgba(91, 124, 153, 0.2); padding: 20px 30px;">
                    <div>
                        <h5 class="modal-title fw-bold" style="color: var(--text-main);">
                            <i class="bi bi-clock-history me-2" style="color: var(--accent-primary);"></i> مێژووی
                            چاکسازی
                        </h5>
                        <div class="text-muted" style="font-size: 0.85rem;">ئاماری چاکسازی قاڵپ</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive" style="max-height: 500px;">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background: rgba(91, 124, 153, 0.05); position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th class="ps-4 py-3 text-secondary text-uppercase border-end-0"
                                        style="font-size: 0.7rem; font-weight: 700; width: 220px;">بەروار و کات</th>
                                    <th class="py-3 text-secondary text-uppercase"
                                        style="font-size: 0.7rem; font-weight: 700; width: 140px;">قاڵب</th>
                                    <th class="py-3 text-secondary text-uppercase"
                                        style="font-size: 0.7rem; font-weight: 700;">گۆڕینی پارچە</th>
                                    <th class="py-3 text-secondary text-uppercase"
                                        style="font-size: 0.7rem; font-weight: 700; width: 180px;">لەلایەن</th>
                                    <th class="pe-4 py-3 text-secondary text-uppercase text-end border-start-0"
                                        style="font-size: 0.7rem; font-weight: 700; width: 100px;">کردار</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Log items injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noHistoryMsg" class="text-center py-5 d-none">
                        <i class="bi bi-journal-x" style="font-size: 3rem; color: #e2e8f0;"></i>
                        <p class="text-muted mt-3">هیچ چاکسازییەک نەدۆزرایەوە.</p>
                    </div>
                </div>
                <div class="modal-footer" style="background: #f8fafc;">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearHistoryLog()">سڕینەوەی
                        سەرجەم </button>
                    <button type="button" class="btn btn-secondary rounded-pill px-4"
                        data-bs-dismiss="modal">داخستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysisModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden; border: none;">
                <div class="modal-header"
                    style="background: rgba(91, 124, 153, 0.1); border-bottom: 1px solid rgba(91, 124, 153, 0.2); padding: 20px 30px;">
                    <h5 class="modal-title fw-bold" style="color: var(--text-main); font-size: 1.25rem;">
                        <i class="bi bi-activity me-2" style="color: var(--accent-primary);"></i> شیکاریی قاڵب
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background: #f1f5f9;">
                                <tr>
                                    <th class="ps-4 py-3 text-secondary text-uppercase"
                                        style="font-size: 0.75rem; font-weight: 700;">ناوی قاڵب</th>
                                    <th class="py-3 text-secondary text-uppercase"
                                        style="font-size: 0.75rem; font-weight: 700;">بارودۆخ</th>
                                    <th class="py-3 text-secondary text-uppercase"
                                        style="font-size: 0.75rem; font-weight: 700;">ماوەی کارکردن</th>
                                    <th class="py-3 text-secondary text-uppercase"
                                        style="font-size: 0.75rem; font-weight: 700;">تەمەنی قاڵب</th>
                                    <th class="pe-4 py-3 text-secondary text-uppercase"
                                        style="font-size: 0.75rem; font-weight: 700; text-align: right;">کردار</th>
                                </tr>
                            </thead>
                            <tbody id="analysisTableBody" style="font-family: 'Inter', sans-serif;">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer" style="background: #f8fafc;">
                    <button type="button" class="btn btn-secondary rounded-pill px-4"
                        data-bs-dismiss="modal">داخستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parts Details Modal -->
    <div class="modal fade" id="partsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; border: none;">
                <div class="modal-header"
                    style="background: rgba(91, 124, 153, 0.1); border-bottom: 1px solid rgba(91, 124, 153, 0.2); padding: 20px 30px;">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div>
                            <h5 class="modal-title fw-bold" id="partsModalTitle" style="color: var(--text-main);">
                                وردەکاری قاڵب</h5>
                            <div class="text-muted" style="font-size: 0.85rem;">ئەو پارچانە هەڵبژێرە کە چاکسازی تیایدا
                                کراوە
                            </div>
                        </div>
                        <div class="d-flex gap-3 align-items-center">
                            <div class="d-flex align-items-center gap-1">
                                <a id="manualLinkDisplay" href="#" target="_blank"
                                    class="btn btn-sm btn-outline-danger rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 35px; height: 35px;" title="تەماشای وێنەکە بکە">
                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                </a>
                                <button id="editManualLinkBtn" class="btn btn-sm btn-link text-secondary p-0 d-none"
                                    onclick="updateManualLink()" title="دەستکاری لینکەکە مەکە">
                                    <i class="bi bi-pencil-fill" style="font-size: 0.8rem;"></i>
                                </button>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary small text-uppercase">بەروار و کاتی
                            چاکسازی</label>
                        <input type="datetime-local" id="maintenanceDateInput"
                            class="form-control form-control-lg rounded-3 border-2" style="border-color: #e2e8f0;">
                    </div>

                    <div class="parts-grid mb-4" id="partsGrid"
                        style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <!-- 20 parts injected here -->
                    </div>

                    <div class="specific-history-section border-top pt-4">
                        <h6 class="fw-bold text-secondary small text-uppercase mb-3">
                            <i class="bi bi-clock-history me-1"></i> مێژووی چاکسازی ئەم قاڵبە
                        </h6>
                        <div id="specificMoldHistoryList" class="bg-light rounded-3 p-2"
                            style="max-height: 250px; overflow-y: auto;">
                            <!-- Filtered logs will be injected here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between" style="background: #f8fafc;">
                    <button type="button" class="btn btn-outline-danger rounded-pill px-4" id="resetHistoryBtn"
                        onclick="resetMoldHistoryInModal()">قاڵبەکە بهێنەوە سەرەتا</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary rounded-pill px-4"
                            data-bs-dismiss="modal">پاشتگەستبوونەوە</button>
                        <button type="button" class="btn btn-primary rounded-pill px-4" id="savePartsBtn"
                            onclick="savePartsState()">پاشەکەوتکردن</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNodAq9MikVHaQRr4EZVfsbXp4SOfxDKQ",
            authDomain: "abf6-96dcf.firebaseapp.com",
            projectId: "abf6-96dcf",
            storageBucket: "abf6-96dcf.firebasestorage.app",
            messagingSenderId: "405357996484",
            appId: "1:405357996484:web:b335cdf768ba415f3e9c91"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const moldStateDoc = db.collection('settings').doc('moldMaintenance');

        // --- 2. State Management ---
        // Mold Categories
        const MOLD_CATEGORIES = {
            'بلۆک': {
                '15cm': ['FIL 535'],
                '20cm': ['FIL 444', 'FIL 445', 'FIL 726', 'FIL 648', 'SF 00']
            },
            'قواتع': {
                '10cm': ['FIL 152', 'SF 79'],
                '15cm': ['FIL 153', 'SF 079'],
                '20cm': ['FIL 154'],
                '24cm': ['FIL 678']
            }
        };

        // Flatten all molds into a single array
        const ALL_MOLDS = [
            // BLOCK - 15cm
            'FIL 535',
            // BLOCK - 20cm
            'FIL 444', 'FIL 445', 'FIL 726', 'FIL 648', 'SF 00',
            // QUATE - 10cm
            'FIL 152', 'SF 79',
            // QUATE - 15cm
            'FIL 153', 'SF 079',
            // QUATE - 20cm
            'FIL 154',
            // QUATE - 24cm
            'FIL 678'
        ];

        const MAX_RUN_MS = 55 * 24 * 60 * 60 * 1000; // 55 Days

        // Helper function to get category info for a mold
        function getMoldCategory(moldName) {
            for (const [productType, sizes] of Object.entries(MOLD_CATEGORIES)) {
                for (const [size, molds] of Object.entries(sizes)) {
                    if (molds.includes(moldName)) {
                        return { productType, size };
                    }
                }
            }
            return { productType: 'Unknown', size: 'Unknown' };
        }

        const DEFAULT_STATE = {
            activeMold: 'FIL 535',
            currentSessionStart: new Date().toISOString(),
            isRunning: true,
            history: {
                'FIL 535': 0, 'FIL 444': 0, 'FIL 445': 0, 'FIL 726': 0, 'FIL 648': 0, 'SF 00': 0,
                'FIL 152': 0, 'SF 79': 0, 'FIL 153': 0, 'SF 079': 0, 'FIL 154': 0, 'FIL 678': 0
            },
            parts: {},
            maintenanceLogs: [],
            manualLink: "https://drive.google.com",
            partNames: {},
            lastUpdated: 0 // New field for sync resolution
        };

        let systemState = DEFAULT_STATE;
        let viewingMold = systemState.activeMold;
        let partStateSnapshot = null;
        let editingLogIdx = null;
        let showDetailedTime = false;
        let unsubscribe = null; // To hold the snapshot listener

        // --- 3. Initialize/Sync State from Firestore ---
        async function initSystemState() {
            // 1. Load from LocalStorage (Instant)
            const localData = localStorage.getItem('moldMaintenanceState');
            if (localData) {
                try {
                    console.log("Loaded state from LocalStorage");
                    systemState = { ...DEFAULT_STATE, ...JSON.parse(localData) };
                    ensureStateIntegrity();
                    if (!viewingMold || !ALL_MOLDS.includes(viewingMold)) viewingMold = systemState.activeMold;
                    renderDashboard();
                } catch (e) { console.error("Local load error", e); }
            }

            // 2. Initial Fetch from Cloud (One-time) to handle offline/online transition
            await syncFromCloud();

            // 3. Setup Real-time Listener
            setupRealtimeListener();
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe(); // Unsubscribe active listener if any

            unsubscribe = moldStateDoc.onSnapshot((doc) => {
                if (doc.exists) {
                    const cloudData = doc.data();
                    const cloudLastUpdated = cloudData.lastUpdated || 0;
                    const localLastUpdated = systemState.lastUpdated || 0;

                    // If cloud has newer data than what we currently have
                    if (cloudLastUpdated > localLastUpdated) {
                        console.log("⚡ Real-time update received!");
                        applyCloudState(cloudData);
                    }
                }
            }, (error) => {
                console.error("Real-time sync error:", error);
            });
        }

        async function syncFromCloud() {
            const btn = document.getElementById('btnSync');
            if (btn) { btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Syncing...'; btn.disabled = true; }

            try {
                const doc = await moldStateDoc.get();
                if (doc.exists) {
                    const cloudData = doc.data();

                    // Conflict Resolution using lastUpdated
                    const cloudLastUpdated = cloudData.lastUpdated || 0;
                    const localLastUpdated = systemState.lastUpdated || 0;

                    if (cloudLastUpdated >= localLastUpdated) {
                        // Cloud is newer or equal, use it
                        console.log("✅ Cloud data is authoritative.");
                        applyCloudState(cloudData);
                    } else {
                        // Local is newer (e.g. offline changes), push to cloud
                        console.log("✅ Local data is newer, pushing to cloud.");
                        await saveState();
                    }
                } else {
                    console.log("No cloud data found. Initializing cloud.");
                    await saveState();
                }
            } catch (error) {
                console.error("Sync Error:", error);
                // Don't alert on automatic syncs to avoid annoyance, just log
            } finally {
                if (btn) { btn.innerHTML = '<i class="bi bi-cloud-check"></i> Sync'; btn.disabled = false; }
            }
        }

        function applyCloudState(cloudData) {
            systemState = { ...DEFAULT_STATE, ...cloudData };
            ensureStateIntegrity();

            // Refresh view
            if (!viewingMold || !ALL_MOLDS.includes(viewingMold)) viewingMold = systemState.activeMold;

            // Update Local Storage to match
            localStorage.setItem('moldMaintenanceState', JSON.stringify(systemState));

            renderDashboard();
            if (document.getElementById('analysisModal').classList.contains('show')) renderAnalysisTable();
            if (document.getElementById('historyModal').classList.contains('show')) renderHistoryTable();

            // If parts modal is open for selection (not editing log), refresh it carefully
            if (document.getElementById('partsModal').classList.contains('show') && editingLogIdx === null) {
                // Option: refresh parts grid if needed, or notify user. 
                // For now, we update the underlying data, but might not force re-render of grid 
                // to avoid disrupting user clicks unless we implemented a smart merge.
            }
        }

        // --- Part Definitions (Editable from Code) ---
        const MOLD_PARTS_DEFINITIONS = {
            'FIL 155': ["155-FIL-03", "155-FIL-1A", "155-FIL-2", "155-FIL-3", "155-FIL-4", "155-FIL-5", "155-FIL-5A", "155-FIL-5B", "155-FIL-6A", "155-FIL-7D", "155-FIL-3F", "155-FIL-5D-OPT", "155-FIL-5C", "155-FIL-9B"],
            'FIL 153': ["153-FIL-03", "153-FIL-1A", "153-FIL-2", "153-FIL-3", "153-FIL-30D-OPT", "153-FIL-30E-OPT", "153-FIL-3E", "153-FIL-5", "153-FIL-51-OPT", "153-FIL-52", "153-FIL-55-OPT", "153-FIL-5A", "153-FIL-5C", "153-FIL-5C-OPT", "153-FIL-5D", "153-FIL-6", "153-FIL-7A", "153-FIL-8A", "153-FIL-9A"],
            'FIL 154': ["154-FIL-9A-T", "154-FIL-30AA", "154-FIL-1A", "154-FIL-2", "154-FIL-7A", "154-FIL-03", "154-FIL-5", "154-FIL-5C-OPT", "154-FIL-52-OPT", "154-FIL-5D", "154-FIL-54", "154-FIL-5C", "154-FIL-3E", "154-FIL-3", "154-FIL-8A", "154-FIL-2E", "154-FIL-2D", "154-FIL-6B"],
            'FIL 445': ["445-FIL-5C", "445-FIL-4", "445-FIL-57-O", "445-FIL-58", "445-FIL-62-O", "445-FIL-63-O", "445-FIL-63", "445-FIL-31A", "445-FIL-57", "445-FIL-64", "445-FIL-5", "445-FIL-03", "445-FIL-3", "445-FIL-7D", "445-FIL-8B", "445-FIL-2", "445-FIL-1A", "445-FIL-9A", "445-FIL-6B"],
            'FIL 535': ["535-FIL-5A", "535-FIL-58-O", "535-FIL-58A-O", "535-FIL-60B", "535-FIL-57-O", "535-FIL-4A", "535-FIL-55-O", "535-FIL-56-O", "535-FIL-62-O", "535-FIL-60-O", "535-FIL-59-O", "535-FIL-31", "535-FIL-31A", "535-FIL-61-O", "535-FIL-63", "535-FIL-60A", "BS-FIL-40", "535-FIL-6A", "BS-FIL-6", "535-FIL-1C", "535-FIL-30I", "535-FIL-9A", "535-FIL-1A", "535-FIL-2", "535-FIL-7A", "535-FIL-8A", "535-FIL-03", "535-FIL-3", "535-FIL-5B", "535-FIL-5", "535-FIL-5C"],
            'FIL 678': ["678-FIL-4A", "678-FIL-31", "678-FIL-60B", "678-FIL-60A", "678-FIL-60C", "678-FIL-54B", "678-FIL-5E", "678-FIL-50B-0", "678-FIL-5A", "678-FIL-5B", "678-FIL-03", "678-FIL-3A", "678-FIL-3", "678-FIL-8A", "678-FIL-7A", "678-FIL-2", "678-FIL-9A", "678-FIL-30DD", "678-FIL-1C", "678-FIL-1A", "678-FIL-6A", "BS-FIL-40", "BS-FIL-6D", "BS-FIL-60", "678-FIL-5", "678-FIL-5D"]
        };

        function ensureStateIntegrity() {
            ALL_MOLDS.forEach(m => {
                // 1. Ensure Names Match Code Definitions (Source of Truth)
                const definedNames = MOLD_PARTS_DEFINITIONS[m];

                if (definedNames) {
                    // If code has definitions, enforce them (allows updating from code)
                    // We also merge with existing to avoid losing user-added parts if intended, 
                    // BUT user asked to "change it from code", so code should be master for the base set.
                    // We'll use the code definitions, plus any *extra* custom parts the user might have added dynamically.

                    // Simple approach: Overwrite active names with Code definitions if they differ significantly or on init
                    // To be safe and support "Add Part", we check if we already have these.

                    if (!systemState.partNames[m] || systemState.partNames[m].length === 0) {
                        systemState.partNames[m] = [...definedNames];
                    } else {
                        // Optional: Force update base names if they changed in code? 
                        // Let's verify if the first N names match. If not, update them.
                        for (let i = 0; i < definedNames.length; i++) {
                            if (systemState.partNames[m][i] !== definedNames[i]) {
                                systemState.partNames[m][i] = definedNames[i];
                            }
                        }
                    }
                } else {
                    // Default fallback
                    if (!systemState.partNames[m] || systemState.partNames[m].length === 0) {
                        systemState.partNames[m] = Array(20).fill(null).map((_, i) => `PART ${i + 1}`);
                    }
                }

                // 2. Ensure Status Array matches Names Length
                const currentLen = systemState.partNames[m].length;
                if (!systemState.parts[m] || !Array.isArray(systemState.parts[m])) {
                    systemState.parts[m] = Array(currentLen).fill(false);
                } else if (systemState.parts[m].length !== currentLen) {
                    while (systemState.parts[m].length < currentLen) systemState.parts[m].push(false);
                    if (systemState.parts[m].length > currentLen) systemState.parts[m] = systemState.parts[m].slice(0, currentLen);
                }
            });
        }

        if (!systemState.history) systemState.history = { ...DEFAULT_STATE.history };
        if (!systemState.maintenanceLogs) systemState.maintenanceLogs = [];
        if (!systemState.manualLink) systemState.manualLink = DEFAULT_STATE.manualLink;
        if (!systemState.partNames) systemState.partNames = {};


        // --- 4. Auth ---
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) window.location.href = 'index.html';
        document.getElementById('userInfoDisplay').innerText = currentUser.username;

        const allowedUsers = ['himat', 'shalaw', 'admin'];
        const canSwitch = allowedUsers.includes(currentUser.username) || currentUser.role === 'admin' || currentUser.role === 'supervisor';

        // --- 5. Logic ---
        function getMoldStats(moldName) {
            let totalMs = systemState.history[moldName] || 0;
            if (systemState.isRunning && moldName === systemState.activeMold) {
                const sessionStart = new Date(systemState.currentSessionStart).getTime();
                const now = new Date().getTime();
                totalMs += Math.max(0, now - sessionStart);
            }

            const days = Math.floor(totalMs / (1000 * 60 * 60 * 24));
            let health = Math.round(100 - ((totalMs / MAX_RUN_MS) * 100));
            health = Math.min(100, Math.max(0, health));

            const startedDate = systemState.currentSessionStart ? new Date(systemState.currentSessionStart).toLocaleDateString('en-GB') : 'Paused';

            return { days, health, startDateFormatted: startedDate, totalMs };
        }

        function toggleTimeFormat() {
            showDetailedTime = !showDetailedTime;
            renderDashboard();
        }

        function editMoldRuntime(moldName) {
            const stats = getMoldStats(moldName);
            const currentDays = (stats.totalMs / (1000 * 60 * 60 * 24)).toFixed(2);

            const newDays = prompt(`بڕی کارکردنی دەستی بنووسە بۆ [${moldName}] بە ڕۆژ (بۆ نموونە: 45.5):`, currentDays);

            if (newDays !== null && newDays.trim() !== "" && !isNaN(newDays)) {
                const totalMs = parseFloat(newDays) * 24 * 60 * 60 * 1000;

                if (systemState.activeMold === moldName && systemState.isRunning) {
                    const now = new Date().getTime();
                    const sessionStart = new Date(systemState.currentSessionStart).getTime();
                    const currentSessionDuration = Math.max(0, now - sessionStart);
                    systemState.history[moldName] = Math.max(0, totalMs - currentSessionDuration);
                } else {
                    systemState.history[moldName] = totalMs;
                }

                saveState();
                renderAnalysisTable();
                renderDashboard();
                showNotification(`مێژووی [${moldName}] نوێکرایەوە`, 'success');
            }
        }

        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '12px 24px';
            toast.style.borderRadius = '12px';
            toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
            toast.style.color = 'white';
            toast.style.zIndex = '9999';
            toast.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
            toast.style.fontWeight = 'bold';
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- 6. Render UI ---
        function renderDashboard() {
            const stats = getMoldStats(viewingMold);
            const isActiveSystem = (viewingMold === systemState.activeMold);
            const category = getMoldCategory(viewingMold);

            // Display mold name with category badge
            const nameElement = document.getElementById('activeName');
            nameElement.innerHTML = `
                ${viewingMold}
                <span class="badge ms-2" style="background: var(--accent-secondary); font-size: 0.7rem; vertical-align: middle;">
                    ${category.productType} - ${category.size}
                </span>
            `;
            nameElement.style.cursor = "pointer";
            nameElement.onclick = () => openPartsDetails(viewingMold);

            const statusPill = document.querySelector('.status-pill');
            if (isActiveSystem && systemState.isRunning) {
                statusPill.innerHTML = '<i class="bi bi-circle-fill"></i>  چالاکە';
                statusPill.style.background = 'rgba(16, 185, 129, 0.1)';
                statusPill.style.color = 'var(--success-color)';
            } else if (isActiveSystem && !systemState.isRunning) {
                statusPill.innerHTML = '<i class="bi bi-pause-circle"></i> وەستاوە ';
                statusPill.style.background = 'rgba(245, 158, 11, 0.1)';
                statusPill.style.color = '#f59e0b';
            } else {
                statusPill.innerHTML = '<i class="bi bi-eye"></i> سەیرکردن';
                statusPill.style.background = 'rgba(59, 130, 246, 0.1)';
                statusPill.style.color = '#3b82f6';
            }

            document.getElementById('activeStarted').innerText = (isActiveSystem && systemState.isRunning) ? stats.startDateFormatted : '---';
            document.getElementById('activeHealth').innerText = stats.health + '%';

            let displayValue = stats.days;
            let displayLabel = "Days Running";

            if (showDetailedTime) {
                const totalSeconds = Math.floor(stats.totalMs / 1000);
                const d = Math.floor(totalSeconds / (3600 * 24));
                const h = Math.floor((totalSeconds % (3600 * 24)) / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = Math.floor(totalSeconds % 60);
                const pad = (n) => n.toString().padStart(2, '0');
                displayValue = `${pad(d)}d ${pad(h)}h ${pad(m)}m ${pad(s)}s`;
                displayLabel = "Total Runtime";
                document.getElementById('daysRunning').style.fontSize = "1.8rem";
            } else {
                document.getElementById('daysRunning').style.fontSize = "4rem";
            }

            document.getElementById('daysRunning').innerText = displayValue;
            document.querySelector('.progress-label').innerText = displayLabel;

            const btnContainer = document.getElementById('actionButtons');
            if (btnContainer) {
                btnContainer.innerHTML = `<button class="btn btn-outline-dark rounded-pill px-4" onclick="openPartsDetails('${viewingMold}')">
                    <i class="bi bi-wrench me-2"></i> تۆمارکردنی چاکسازی
                </button>`;
            }

            const circle = document.getElementById('progressCircle');
            let color = '#10b981';
            if (stats.health < 50) color = '#f59e0b';
            if (stats.health < 20) color = '#ef4444';
            circle.style.background = `conic-gradient(${color} 0%, ${color} ${stats.health}%, #f1f5f9 ${stats.health}%, #f1f5f9 100%)`;

            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';

            // Group molds by product type (BLOCK/QUATE) for high-density layout
            Object.entries(MOLD_CATEGORIES).forEach(([productType, sizes]) => {
                // Add product type header
                const catHeader = document.createElement('div');
                catHeader.className = 'grid-header mt-3';
                catHeader.innerHTML = `<div class="grid-category-title"><i class="bi bi-box-seam"></i> ${productType}</div>`;
                grid.appendChild(catHeader);

                // Flatten all sizes for this product type and create cards
                Object.entries(sizes).forEach(([size, molds]) => {
                    molds.forEach(mold => {
                        const moldStats = getMoldStats(mold);
                        const card = document.createElement('div');
                        card.className = 'inv-card';
                        if (mold === viewingMold) card.style.borderColor = "var(--text-main)";

                        card.onclick = () => {
                            viewingMold = mold;
                            renderDashboard();
                        };

                        let statusText = moldStats.days > 0 ? `Day ${moldStats.days}` : "New";
                        let statusColor = moldStats.days > 0 ? "text-secondary" : "text-success";
                        if (mold === systemState.activeMold && systemState.isRunning) {
                            statusText = "RUNNING";
                            statusColor = "text-success fw-bold";
                        }

                        card.innerHTML = `
                            <div class="inv-icon"><i class="bi bi-gear-fill" style="font-size: 0.7rem;"></i></div>
                            <div class="inv-content">
                                <div class="inv-name-row">
                                    <div class="inv-name">${mold}</div>
                                    <div class="inv-size-badge">${size}</div>
                                </div>
                                <div class="inv-status-row">
                                    <div class="inv-status ${statusColor}">${statusText}</div>
                                    <div class="inv-health-mini">${moldStats.health}% HLT</div>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                });
            });
        }

        // --- 7. Actions ---
        function switchMold(newMoldName) {
            if (!canSwitch) return alert("Access Denied");
            if (systemState.isRunning) {
                const sessionStart = new Date(systemState.currentSessionStart).getTime();
                const duration = Math.max(0, new Date().getTime() - sessionStart);
                systemState.history[systemState.activeMold] += duration;
            }
            systemState.activeMold = newMoldName;
            systemState.currentSessionStart = new Date().toISOString();
            systemState.isRunning = true;
            saveState();
        }

        function stopActiveMold() {
            if (!canSwitch) return alert("Access Denied");
            if (systemState.isRunning) {
                const sessionStart = new Date(systemState.currentSessionStart).getTime();
                systemState.history[systemState.activeMold] += Math.max(0, new Date().getTime() - sessionStart);
            }
            systemState.isRunning = false;
            saveState();
        }

        function restartActiveMold(moldName) {
            if (!canSwitch) return alert("Access Denied");
            if (confirm(`RESTART CYCLE for [${moldName}]? This resets history to zero.`)) {
                systemState.history[moldName] = 0;
                if (moldName === systemState.activeMold) {
                    systemState.currentSessionStart = new Date().toISOString();
                }
                saveState();
            }
        }

        function startSpecificMold(moldName) {
            if (!canSwitch) return alert("Access Denied");
            if (moldName === systemState.activeMold) {
                systemState.currentSessionStart = new Date().toISOString();
                systemState.isRunning = true;
            } else {
                switchMold(moldName);
            }
            saveState();
        }

        function openAnalysis() {
            new bootstrap.Modal(document.getElementById('analysisModal')).show();
            renderAnalysisTable();
        }

        function renderAnalysisTable() {
            const tbody = document.getElementById('analysisTableBody');
            tbody.innerHTML = '';

            // Group molds by category
            Object.entries(MOLD_CATEGORIES).forEach(([productType, sizes]) => {
                // Add category header
                const categoryHeader = document.createElement('tr');
                categoryHeader.style.background = 'linear-gradient(135deg, rgba(91, 124, 153, 0.1) 0%, rgba(91, 124, 153, 0.05) 100%)';
                categoryHeader.innerHTML = `
                    <td colspan="5" class="ps-4 py-3">
                        <div class="fw-bold" style="font-size: 1.1rem; color: var(--accent-primary); letter-spacing: 1px;">
                            <i class="bi bi-box-seam me-2"></i>${productType}
                        </div>
                    </td>
                `;
                tbody.appendChild(categoryHeader);

                // Add molds for each size within this category
                Object.entries(sizes).forEach(([size, molds]) => {
                    // Add size subheader
                    const sizeHeader = document.createElement('tr');
                    sizeHeader.style.background = 'rgba(0, 0, 0, 0.02)';
                    sizeHeader.innerHTML = `
                        <td colspan="5" class="ps-5 py-2">
                            <span class="badge" style="background: var(--accent-secondary); font-size: 0.75rem;">${size}</span>
                        </td>
                    `;
                    tbody.appendChild(sizeHeader);

                    // Add each mold in this size
                    molds.forEach(mold => {
                        const stats = getMoldStats(mold);
                        const isActive = (mold === systemState.activeMold && systemState.isRunning);
                        const isPaused = (mold === systemState.activeMold && !systemState.isRunning);

                        const totalSeconds = Math.floor(stats.totalMs / 1000);
                        const d = Math.floor(totalSeconds / (3600 * 24));
                        const h = Math.floor((totalSeconds % (3600 * 24)) / 3600);
                        const m = Math.floor((totalSeconds % 3600) / 60);
                        const s = Math.floor(totalSeconds % 60);
                        const pad = (n) => n.toString().padStart(2, '0');

                        let statusBadge = '<span class="badge bg-secondary">ناچالاک</span>';
                        if (isActive) statusBadge = '<span class="badge bg-success">چالاک</span>';
                        if (isPaused) statusBadge = '<span class="badge bg-warning text-dark">وەستاوە</span>';

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="ps-5">
                                <a href="#" class="fw-bold text-decoration-none text-dark" onclick="viewOnDashboard('${mold}'); return false;">${mold}</a>
                            </td>
                            <td>${statusBadge}</td>
                            <td class="font-monospace">
                                ${d}d ${pad(h)}:${pad(m)}:${pad(s)}
                                <button class="btn btn-sm btn-link text-muted p-0 ms-1" onclick="editMoldRuntime('${mold}')" title="دەستکاری کردنی مێژوو">
                                    <i class="bi bi-pencil-square" style="font-size: 0.8rem;"></i>
                                </button>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress flex-grow-1" style="height: 6px; width: 80px;">
                                        <div class="progress-bar ${stats.health < 20 ? 'bg-danger' : 'bg-success'}" style="width: ${stats.health}%"></div>
                                    </div>
                                    <span style="font-size: 0.8rem">${stats.health}%</span>
                                </div>
                            </td>
                            <td class="pe-4 text-end">
                                <div class="btn-group">
                                    ${isActive ?
                                `<button class="btn btn-sm btn-danger" onclick="stopActiveMold()"><i class="bi bi-pause-fill"></i></button>` :
                                `<button class="btn btn-sm btn-success" onclick="startSpecificMold('${mold}')"><i class="bi bi-play-fill"></i></button>`
                            }
                                    <button class="btn btn-sm" style="border: 1px solid var(--accent-primary); color: var(--accent-primary);" onclick="openPartsDetails('${mold}')"><i class="bi bi-wrench"></i></button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="restartActiveMold('${mold}')"><i class="bi bi-arrow-counterclockwise"></i></button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            });
        }

        function viewOnDashboard(mold) {
            viewingMold = mold;
            renderDashboard();
            bootstrap.Modal.getInstance(document.getElementById('analysisModal')).hide();
        }

        function openHistory() {
            new bootstrap.Modal(document.getElementById('historyModal')).show();
            renderHistoryTable();
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const noMsg = document.getElementById('noHistoryMsg');
            tbody.innerHTML = '';
            const logs = [...systemState.maintenanceLogs].reverse();
            if (logs.length === 0) {
                noMsg.classList.remove('d-none');
            } else {
                noMsg.classList.add('d-none');
                logs.forEach((log, reversedIdx) => {
                    const originalIdx = (systemState.maintenanceLogs.length - 1) - reversedIdx;
                    const dateObj = new Date(log.timestamp);
                    const dateStr = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = dateObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                    let changesBadge = '';
                    if (log.type === 'RESET') {
                        changesBadge = '<span class="badge bg-danger rounded-pill px-3 py-2 shadow-sm"><i class="bi bi-arrow-counterclockwise me-1"></i> MOLD RESET (ALL)</span>';
                    } else if (log.changes && log.changes.length > 0) {
                        changesBadge = log.changes.map(c => `
                            <span class="badge bg-white text-dark border-0 shadow-sm px-3 py-2 me-1 mb-1" style="border-radius: 8px;">
                                <i class="bi bi-cpu text-secondary me-1" style="font-size: 0.7rem;"></i> ${c}
                            </span>
                        `).join('');
                    } else {
                        changesBadge = '<span class="badge bg-secondary rounded-pill px-3 py-2">Checked (No changes)</span>';
                    }

                    const isAdmin = currentUser.username === 'admin' || currentUser.role === 'admin';
                    const tr = document.createElement('tr');
                    tr.className = "history-row";
                    tr.innerHTML = `
                        <td class="ps-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-light rounded-3 p-2 text-center" style="min-width: 60px;">
                                    <div class="fw-bold" style="font-size: 0.9rem;">${dateStr.split(' ')[0]}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">${dateStr.split(' ')[1]}</div>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem; font-family: monospace;">${timeStr}</div>
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold" style="color: var(--accent-primary);">${log.mold}</div>
                            <div class="small text-muted">Mold ID</div>
                        </td>
                        <td style="max-width: 400px;">
                            <div class="d-flex flex-wrap gap-1 py-2">${changesBadge}</div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" 
                                     style="width: 28px; height: 28px; font-size: 0.7rem; background: var(--accent-secondary) !important;">
                                    ${log.user[0].toUpperCase()}
                                </div>
                                <div class="small">
                                    <div class="fw-bold">${log.user}</div>
                                    ${log.lastEditedBy ? `<div class="text-muted" style="font-size: 0.65rem;">Updated by ${log.lastEditedBy}</div>` : '<div class="text-muted" style="font-size: 0.65rem;">تۆمارکراوە</div>'}
                                </div>
                            </div>
                        </td>
                         <td class="pe-4 text-end">
                             <div class="d-flex justify-content-end gap-2">
                                 ${isAdmin ?
                            `<button class="btn btn-sm btn-outline-secondary rounded-pill px-3 shadow-sm border-0 bg-white" 
                                              onclick="openPartsDetails('${log.mold}', ${originalIdx})" style="font-size: 0.75rem;">
                                        <i class="bi bi-pencil-square me-1"></i> Edit
                                     </button>
                                     <button class="btn btn-sm btn-outline-danger rounded-pill px-3 shadow-sm border-0 bg-white" 
                                              onclick="deleteHistoryLogEntry(${originalIdx})" style="font-size: 0.75rem;">
                                        <i class="bi bi-trash me-1"></i> Delete
                                     </button>` : ''
                        }
                             </div>
                         </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function clearHistoryLog() {
            if (confirm("Permanently delete ALL maintenance logs? This cannot be undone.")) {
                systemState.maintenanceLogs = [];
                saveState();
            }
        }

        function deleteHistoryLogEntry(idx) {
            if (confirm("Delete this maintenance record?")) {
                systemState.maintenanceLogs.splice(idx, 1);
                saveState();
            }
        }

        async function updateManualLink() {
            let currentLink = document.getElementById('manualLinkDisplay').href;
            const newLink = prompt("Enter PDF Link for " + currentEditingMold, currentLink);
            if (newLink) {
                if (typeof systemState.manualLink === 'string') {
                    const oldDefault = systemState.manualLink;
                    systemState.manualLink = { 'default': oldDefault };
                }
                if (!systemState.manualLink) systemState.manualLink = {};

                systemState.manualLink[currentEditingMold] = newLink;
                await saveState();
                document.getElementById('manualLinkDisplay').href = newLink;
            }
        }

        let currentEditingMold = '';
        function openPartsDetails(moldName, logIdx = null) {
            currentEditingMold = moldName;
            editingLogIdx = logIdx;
            document.getElementById('partsModalTitle').innerText = logIdx !== null ? `Edit Maintenance - ${moldName}` : `${moldName} - Selection`;
            document.getElementById('savePartsBtn').innerText = logIdx !== null ? "Update Log" : "Save Changes";

            // Resolve Link (Per-Mold or Global)
            let link = "https://drive.google.com";
            if (typeof systemState.manualLink === 'string') {
                link = systemState.manualLink;
            } else if (systemState.manualLink) {
                link = systemState.manualLink[moldName] || systemState.manualLink['default'] || "https://drive.google.com";
            }
            document.getElementById('manualLinkDisplay').href = link;
            const editBtn = document.getElementById('editManualLinkBtn');
            const isAdmin = currentUser.username === 'admin' || currentUser.role === 'admin';
            if (isAdmin) editBtn.classList.remove('d-none'); else editBtn.classList.add('d-none');

            if (logIdx !== null) {
                const log = systemState.maintenanceLogs[logIdx];
                const date = new Date(log.timestamp);
                const offset = date.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(date - offset)).toISOString().slice(0, 16);
                document.getElementById('maintenanceDateInput').value = localISOTime;
                const names = systemState.partNames[moldName];
                systemState.parts[moldName] = names.map(name => log.changes.includes(name));
            } else {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
                document.getElementById('maintenanceDateInput').value = localISOTime;
                systemState.parts[moldName] = Array(20).fill(false);
            }
            // Show modal explicitly
            const partsModal = new bootstrap.Modal(document.getElementById('partsModal'));
            partsModal.show();
            renderPartsGrid(); // Initial render
        }

        function renderPartsGrid() {
            const grid = document.getElementById('partsGrid');
            const status = systemState.parts[currentEditingMold];
            const names = systemState.partNames[currentEditingMold];
            const isAdmin = currentUser.username === 'admin' || currentUser.role === 'admin';
            grid.innerHTML = '';

            names.forEach((partName, i) => {
                const isSelected = status[i];
                const div = document.createElement('div');
                div.className = "p-2 border rounded text-center position-relative";
                div.style.background = isSelected ? "rgba(31, 41, 55, 0.05)" : "white";
                div.style.borderColor = isSelected ? "var(--text-main)" : "#e2e8f0";
                div.style.borderWidth = isSelected ? "2px" : "1px";
                div.style.cursor = "pointer";
                div.style.minHeight = "80px";
                div.style.display = "flex";
                div.style.flexDirection = "column";
                div.style.justifyContent = "center";
                div.innerHTML = `
                    <div class="fw-bold" style="font-size: 0.8rem; ${isSelected ? 'color: var(--text-main)' : ''}">${partName}</div>
                    <div class="mt-1 text-muted small" style="font-size: 0.7rem;"><i class="bi bi-${isSelected ? 'check-square-fill text-dark' : 'square'}"></i></div>
                    ${isAdmin ? `
                        <div class="position-absolute" style="top: 2px; right: 5px;">
                            <button class="btn btn-sm btn-link text-secondary p-0 me-1" onclick="event.stopPropagation(); renamePart(${i})" title="Rename"><i class="bi bi-pencil" style="font-size: 0.7rem;"></i></button>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="event.stopPropagation(); deletePart(${i})" title="Delete Completely"><i class="bi bi-trash" style="font-size: 0.7rem;"></i></button>
                        </div>
                    ` : ''}
                `;
                div.onclick = () => { status[i] = !status[i]; renderPartsGrid(); };
                grid.appendChild(div);
            });

            // Add Part Button for Admins
            if (isAdmin) {
                const addDiv = document.createElement('div');
                addDiv.className = "p-2 border rounded text-center d-flex align-items-center justify-content-center text-muted";
                addDiv.style.borderStyle = "dashed";
                addDiv.style.cursor = "pointer";
                addDiv.style.background = "#f8fafc";
                addDiv.style.minHeight = "80px";
                addDiv.onclick = addPart;
                addDiv.innerHTML = `<div><i class="bi bi-plus-circle mb-1" style="font-size: 1.2rem;"></i><div style="font-size: 0.75rem; font-weight: 600;">Add Part</div></div>`;
                grid.appendChild(addDiv);
            }
        }

        async function renamePart(index) {
            const currentName = systemState.partNames[currentEditingMold][index];
            const newName = prompt(`Rename ${currentName} for ${currentEditingMold}:`, currentName);
            if (newName !== null && newName.trim() !== "") {
                systemState.partNames[currentEditingMold][index] = newName.trim();
                await saveState(); // Await save
                renderPartsGrid(); // Re-render grid immediately
            }
        }

        async function deletePart(index) {
            if (confirm("Are you sure you want to DELETE this part completely?")) {
                systemState.partNames[currentEditingMold].splice(index, 1);
                systemState.parts[currentEditingMold].splice(index, 1);
                await saveState();
                renderPartsGrid();
            }
        }

        async function addPart() {
            const name = prompt("Enter new part name:");
            if (name && name.trim()) {
                systemState.partNames[currentEditingMold].push(name.trim());
                systemState.parts[currentEditingMold].push(false);
                await saveState();
                renderPartsGrid();
            }
        }

        function savePartsState() {
            const currentParts = systemState.parts[currentEditingMold];
            const partNames = systemState.partNames[currentEditingMold];
            const changedParts = [];
            const selectedDate = document.getElementById('maintenanceDateInput').value;
            const finalTimestamp = selectedDate ? new Date(selectedDate).toISOString() : new Date().toISOString();

            // Dynamic Loop
            for (let i = 0; i < currentParts.length; i++) if (currentParts[i]) changedParts.push(partNames[i]);

            if (changedParts.length > 0) {
                if (editingLogIdx !== null) {
                    const log = systemState.maintenanceLogs[editingLogIdx];
                    log.timestamp = finalTimestamp;
                    log.changes = changedParts;
                    log.lastEditedBy = currentUser.username;
                    editingLogIdx = null;
                } else {
                    systemState.maintenanceLogs.push({
                        timestamp: finalTimestamp,
                        mold: currentEditingMold,
                        type: 'UPDATE',
                        changes: changedParts,
                        user: currentUser.username
                    });
                }
                systemState.parts[currentEditingMold] = Array(currentParts.length).fill(false); // Reset to false, keep length
            } else {
                alert("No parts selected to save.");
                return;
            }
            saveState();
            bootstrap.Modal.getInstance(document.getElementById('partsModal')).hide();
        }

        function resetMoldHistoryInModal() {
            if (confirm("Reset everything for this mold? This resets its timer and clears any pending parts.")) {
                systemState.history[currentEditingMold] = 0;
                systemState.parts[currentEditingMold] = Array(systemState.partNames[currentEditingMold].length).fill(false);
                systemState.maintenanceLogs.push({
                    timestamp: new Date().toISOString(),
                    mold: currentEditingMold,
                    type: 'RESET',
                    changes: ['Full System Cycles Reset'],
                    user: currentUser.username
                });
                saveState();
                bootstrap.Modal.getInstance(document.getElementById('partsModal')).hide();
            }
        }

        async function saveState() {
            try {
                systemState.lastUpdated = Date.now(); // Update timestamp
                const stateToSave = { ...systemState };
                localStorage.setItem('moldMaintenanceState', JSON.stringify(stateToSave));
                await moldStateDoc.set(stateToSave);
            } catch (error) {
                console.error("Error saving state: ", error);
            }
        }


        setInterval(renderDashboard, 1000);
        document.addEventListener('DOMContentLoaded', () => {
            initSystemState();
        });

    </script>
</body>

</html>
