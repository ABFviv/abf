<!DOCTYPE html>
<html lang="ku" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASOBRICK - مانوەڵەکان</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --light-bg: #f5f7fa;
            --primary-color: #006f57;
            /* Department Colors */
            --col-crushing: #795548;
            /* Brown */
            --col-prep: #009688;
            /* Teal */
            --col-cutting: #FF5722;
            /* Deep Orange */
            --col-setting: #673AB7;
            /* Purple (Setting) */
            --col-dryer: #FFC107;
            /* Amber */
            --col-kiln: #D32F2F;
            /* Red */
            --col-unloading: #4CAF50;
            /* Green */
            --col-electrical: #a60566;
            /* Gold */
            --col-mechanical: #1d0feb;
            /* Blue Grey */
        }

        body {
            background-color: #f8fafc;
            font-family: 'Inter', 'Noto Sans Arabic', sans-serif;
            padding: 15px;
        }

        /* --- Header --- */
        .header-bar {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 25px rgba(56, 142, 60, 0.15);
        }

        .btn-header {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 8px 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .btn-header:hover {
            background: white !important;
            color: #388e3c !important;
            transform: translateY(-2px);
            border-color: white;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .user-badge {
            background: white;
            color: #388e3c;
            padding: 6px 16px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        /* --- VIEW 1: Department Folders --- */
        .dept-card {
            background: rgb(255, 255, 255);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #000000;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .dept-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .dept-icon-box {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .dept-title {
            font-weight: 800;
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 5px;
        }

        .dept-count {
            color: #888;
            font-size: 0.9rem;
            background: #f0f0f0;
            padding: 2px 10px;
            border-radius: 10px;
        }

        /* --- VIEW 2: Manuals List --- */
        .manual-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #eee;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .manual-card:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .manual-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .manual-info {
            flex-grow: 1;
        }

        .manual-name {
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .manual-type {
            font-size: 0.8rem;
            color: #999;
        }

        .btn-fab {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
            /* Admin only */
            z-index: 1000;
        }
    </style>
</head>

<body>

    <div class="toast-container position-fixed top-0 start-0 p-3"></div>

    <div class="container pb-5">
        <div class="header-bar">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="bi bi-folder2-open fs-5"></i>
                </div>
                <div>
                    <h5 class="m-0 fw-bold" style="letter-spacing: 0.5px;">مانوەڵەکان</h5>
                    <div style="font-size: 0.65rem; opacity: 0.8; font-weight: 600;">TECHNICAL MANUALS & DOCS</div>
                </div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="user-badge" id="userInfo">
                    <i class="bi bi-person-circle fs-5"></i>
                    <span>User</span>
                </div>
                <button class="btn btn-header" onclick="window.location.href='dashboard.html'">
                    <i class="bi bi-arrow-right-short fs-4"></i>
                    <span>گەڕانەوە</span>
                </button>
            </div>
        </div>

        <div id="view-departments">
            <h5 class="mb-4 text-muted border-bottom pb-2">بەشێک هەڵبژێرە:</h5>
            <div class="row g-4" id="deptGrid">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>

        <div id="view-manuals" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-light border text-primary px-3" onclick="showDepartments()">
                    <i class="bi bi-arrow-right me-1"></i> گەڕانەوە
                </button>
                <h4 class="m-0 fw-bold text-primary" id="currentDeptTitle"></h4>
                <div style="width: 100px;"></div>
            </div>

            <div class="input-group mb-4 shadow-sm">
                <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control border-0" id="manualSearch" placeholder="گەڕان لەم بەشە..."
                    onkeyup="filterManuals()">
            </div>

            <div class="row g-3" id="manualsGrid">
            </div>
        </div>
    </div>

    <button class="btn btn-primary btn-fab" id="addBtn" onclick="openModal()">
        <i class="bi bi-plus-lg"></i>
    </button>

    <div class="modal fade" id="manualModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">زیادکردنی کتێب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="manualForm">
                        <input type="hidden" id="manualId">

                        <div class="mb-3">
                            <label class="form-label">ناونیشان</label>
                            <input type="text" class="form-control" id="inpTitle" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">بەش</label>
                            <select class="form-select" id="inpDept" required>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">لینک (URL)</label>
                            <input type="url" class="form-control" id="inpLink" placeholder="Google Drive Link..."
                                required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">جۆر</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="typeOption" id="typePdf" value="pdf"
                                    checked>
                                <label class="btn btn-outline-secondary" for="typePdf">PDF</label>

                                <input type="radio" class="btn-check" name="typeOption" id="typeVideo" value="video">
                                <label class="btn btn-outline-secondary" for="typeVideo">Video</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">داخستن</button>
                    <button type="button" class="btn btn-primary" onclick="saveManual()">پاشەکەوتکردن</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNodAq9MikVHaQRr4EZVfsbXp4SOfxDKQ",
            authDomain: "abf6-96dcf.firebaseapp.com",
            projectId: "abf6-96dcf",
            storageBucket: "abf6-96dcf.firebasestorage.app",
            messagingSenderId: "405357996484",
            appId: "1:405357996484:web:b335cdf768ba415f3e9c91"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Updated Departments based on your request
        const departments = [
            { id: 'crushing', label: 'هاڕین', icon: 'bi-hammer', color: 'var(--col-crushing)' },
            { id: 'prep', label: 'ئامادەکردن', icon: 'bi-tornado', color: 'var(--col-prep)' },
            { id: 'cutting', label: 'بڕین', icon: 'bi-scissors', color: 'var(--col-cutting)' },
            { id: 'setting', label: 'بارکردن', icon: 'bi-bricks', color: 'var(--col-setting)' }, // FIXED: Setting Area
            { id: 'dryer', label: 'درایەر', icon: 'bi-brightness-high', color: 'var(--col-dryer)' },
            { id: 'kiln', label: 'فڕن', icon: 'bi-fire', color: 'var(--col-kiln)' },
            { id: 'unloading', label: 'داگرتن', icon: 'bi-box-seam', color: 'var(--col-unloading)' },
            { id: 'electrical', label: 'کارەبا', icon: 'bi-lightning-charge', color: 'var(--col-electrical)' },
            { id: 'mechanical', label: 'میکانیک', icon: 'bi-gear-wide-connected', color: 'var(--col-mechanical)' }
        ];

        let currentUser = null;
        let allManuals = [];
        let currentDeptId = null;

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const stored = JSON.parse(localStorage.getItem('currentUser'));
            currentUser = stored;
            document.getElementById('userInfo').querySelector('span').innerText = currentUser.username;

            if (['admin', 'manager'].includes(currentUser.role)) {
                document.getElementById('addBtn').style.display = 'block';
            }

            // Populate Select Options in Modal
            const select = document.getElementById('inpDept');
            departments.forEach(d => {
                select.innerHTML += `<option value="${d.id}">${d.label}</option>`;
            });

            loadData();
        });

        // --- 3. DATA LOADING ---
        function loadData() {
            db.collection('manuals').orderBy('createdAt', 'desc').onSnapshot(snap => {
                allManuals = [];
                snap.forEach(doc => allManuals.push({ id: doc.id, ...doc.data() }));

                if (!currentDeptId) {
                    renderDepartments();
                } else {
                    renderManuals(currentDeptId);
                }
            });
        }

        // --- 4. VIEW LOGIC ---

        // View 1: Show 9 Department Folders
        function renderDepartments() {
            document.getElementById('view-departments').style.display = 'block';
            document.getElementById('view-manuals').style.display = 'none';
            currentDeptId = null;

            const grid = document.getElementById('deptGrid');
            grid.innerHTML = '';

            departments.forEach(dept => {
                // Count manuals for this dept
                const count = allManuals.filter(m => m.department === dept.id).length;

                grid.innerHTML += `
                    <div class="col-md-4 col-sm-6">
                        <div class="dept-card" onclick="openDepartment('${dept.id}')">
                            <div class="dept-icon-box" style="background-color: ${dept.color}">
                                <i class="bi ${dept.icon}"></i>
                            </div>
                            <div class="dept-title">${dept.label}</div>
                            <span class="dept-count">${count} فایل</span>
                        </div>
                    </div>
                `;
            });
        }

        // View 2: Show Manuals for ONE Department
        function openDepartment(deptId) {
            currentDeptId = deptId;
            const deptInfo = departments.find(d => d.id === deptId);

            document.getElementById('view-departments').style.display = 'none';
            document.getElementById('view-manuals').style.display = 'block';

            // Set Header with Icon
            document.getElementById('currentDeptTitle').innerHTML =
                `<i class="bi ${deptInfo.icon}" style="color:${deptInfo.color}"></i> ${deptInfo.label}`;

            renderManuals(deptId);
        }

        function showDepartments() {
            renderDepartments();
        }

        function renderManuals(deptId) {
            const grid = document.getElementById('manualsGrid');
            grid.innerHTML = '';

            const filteredManuals = allManuals.filter(m => m.department === deptId);
            const isAdmin = ['admin', 'manager'].includes(currentUser.role);

            if (filteredManuals.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted mt-5"><h5>هیچ فایلێک لەم بەشە نییە</h5></div>';
                return;
            }

            filteredManuals.forEach(m => {
                const icon = m.type === 'video' ? 'bi-play-circle-fill text-danger' : 'bi-file-earmark-pdf-fill text-primary';

                const adminBtns = isAdmin ? `
                    <div class="ms-2 border-start ps-2">
                        <button class="btn btn-sm text-secondary" onclick="editManual('${m.id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm text-danger" onclick="deleteManual('${m.id}')"><i class="bi bi-trash"></i></button>
                    </div>
                ` : '';

                grid.innerHTML += `
                    <div class="col-md-6 manual-item">
                        <div class="manual-card">
                            <div class="manual-icon">
                                <i class="bi ${icon}"></i>
                            </div>
                            <div class="manual-info">
                                <h6 class="manual-name">${m.title}</h6>
                                <span class="manual-type">${m.type.toUpperCase()}</span>
                            </div>
                            <a href="${m.link}" target="_blank" class="btn btn-sm btn-outline-primary">کردنەوە</a>
                            ${adminBtns}
                        </div>
                    </div>
                `;
            });
        }

        // --- 5. CRUD ACTIONS ---
        function openModal() {
            document.getElementById('manualForm').reset();
            document.getElementById('manualId').value = '';
            document.getElementById('modalTitle').textContent = 'زیادکردنی کتێب';

            // If we are inside a department folder, auto-select it
            if (currentDeptId) {
                document.getElementById('inpDept').value = currentDeptId;
            }

            new bootstrap.Modal(document.getElementById('manualModal')).show();
        }

        function editManual(id) {
            const m = allManuals.find(x => x.id === id);
            if (!m) return;
            document.getElementById('manualId').value = m.id;
            document.getElementById('inpTitle').value = m.title;
            document.getElementById('inpDept').value = m.department;
            document.getElementById('inpLink').value = m.link;
            document.querySelector(`input[name="typeOption"][value="${m.type}"]`).checked = true;
            document.getElementById('modalTitle').textContent = 'دەستکاریکردن';
            new bootstrap.Modal(document.getElementById('manualModal')).show();
        }

        async function saveManual() {
            const id = document.getElementById('manualId').value;
            const data = {
                title: document.getElementById('inpTitle').value,
                department: document.getElementById('inpDept').value,
                link: document.getElementById('inpLink').value,
                type: document.querySelector('input[name="typeOption"]:checked').value,
                updatedAt: new Date().toISOString()
            };

            if (!data.title || !data.link) { showToast('تکایە هەموو زانیاریەکان پڕبکەوە', 'warning'); return; }

            try {
                if (id) {
                    await db.collection('manuals').doc(id).update(data);
                    showToast('نوێکرایەوە', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await db.collection('manuals').add(data);
                    showToast('زیادکرا', 'success');
                }
                bootstrap.Modal.getInstance(document.getElementById('manualModal')).hide();
                // Stay in current view
            } catch (e) {
                console.error(e);
                showToast('هەڵە ڕوویدا', 'danger');
            }
        }

        async function deleteManual(id) {
            if (confirm('دڵنیایت؟')) {
                try {
                    await db.collection('manuals').doc(id).delete();
                    showToast('سڕایەوە', 'success');
                } catch (e) { showToast('هەڵە', 'danger'); }
            }
        }

        // --- UTILS ---
        function filterManuals() {
            const term = document.getElementById('manualSearch').value.toLowerCase();
            const items = document.querySelectorAll('.manual-item');
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function showToast(msg, type) {
            const container = document.querySelector('.toast-container');
            const el = document.createElement('div');
            el.className = `toast show align-items-center text-white bg-${type} border-0`;
            el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div></div>`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }
    </script>
</body>

</html>
